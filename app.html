<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bloomii</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <section id="login-page">
        <h1>WELCOME TO BLOOMII =)</h1>
        <h2>Be the best version of yourself with us. </h2>
        <h2>You can explore the world of bloomii by log in or register, the choice is yours!</h2>
        <div id="choice-buttons">
            <button onclick="showForm('register')" type="button">Register</button>
            <button onclick="showForm('login')" type="button">Login</button>
        </div>

        <form id="user-form" action="" method="POST" style="display:none;">
            <h2 id="form-title"></h2>
            <label for="Uname">Username</label>
            <input type="text" id="username" name="username" required
            pattern="^[a-zA-Z0-9_]{3,15}$"
            title="Username harus 3-15 karakter dan hanya boleh huruf, angka, dan underscore">
            <br>
            <label for="">Password</label>
            <input type="password" name="password" placeholder="Password"
        pattern="^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*?&]).+$"
        title="Harus mengandung huruf, angka, dan simbol.">
            <br><br>
            <button type="submit">Submit</button>
            <button type="button" onclick="backToChoice()">Back</button>
        </form>
    </section>

    <section id="menu-page" class="page hidden">
        <div class="container">
        <h2>Welcome, <span id="current-user"></span>!</h2>
        <div class="menu-buttons">
            <button onclick="showPage('bmi-page')">BMI Tracker</button>
            <button onclick="showPage('mood-page')">Mood Calendar</button>
            <button onclick="showPage('quiz-page')">Body Shape Quiz</button>



            <button onclick="logout()">Logout</button>
        </div>
        </div>
    </section>

    <section id="bmi-page" class="page hidden">
        <div class="container">
        <h2>BMI Tracker</h2>
        <form id="bmi-form">
            <div class="form-group">
            <label for="height">Height (cm)</label>
            <input type="number" id="height" name="height" required min="100" max="250">
            </div>
            <div class="form-group">
            <label for="weight">Weight (kg)</label>
            <input type="number" id="weight" name="weight" required min="30" max="200" step="0.1">
            </div>
            <button type="submit">Calculate BMI</button>
        </form>
        <div id="bmi-result"></div>
        <canvas id="bmiChart" style="margin: 20px 0;"></canvas>
        <button onclick="showPage('menu-page')">Back</button>
        </div>
    </section>

    <section id="mood-page" class="page hidden">
  <div class="container" id="mood-step-1">
    <h2>How are you today?</h2>
    <div class="emoji-options">
      <button onclick="selectMood('happy')">üòä</button>
      <button onclick="selectMood('sad')">üò¢</button>
      <button onclick="selectMood('angry')">üò°</button>
      <button onclick="selectMood('fear')">üò®</button>
      <button onclick="selectMood('disgusted')">ü§¢</button>
    </div>
    <button onclick="showPage('menu-page')">Back</button>
  </div>

  <div class="container hidden" id="mood-step-2">
    <h2>Write your journal</h2>
    <textarea id="mood-note" placeholder="How was your day?"></textarea>
    <br></br>
    <button onclick="saveMood()">Save</button>
    <button onclick="cancelMood()">Cancel</button>
  </div>

  <div class="container hidden" id="mood-step-3">
    <h2>Your Mood Calendar</h2>
    <div id="calendar"></div>
    <div id="mood-count"></div>
    <div id="today-mood"></div>
    <button onclick="showPage('menu-page')">Back</button>
  </div>
</section>

<section id="quiz-page" class="page hidden">
  <div class="container">
    <h2>Body Shape Quiz</h2>
    <div id="quizBox">
      <p id="quizQuestion"></p>
      <div id="quizOptions"></div>

      <div class="quiz-nav" style="margin-top:16px;">
        <button id="backBtn" style="display:none;">‚¨Ö Back</button>
        <button id="nextBtn" style="display:none;">Next ‚û°</button>
        <!-- Tambahin ini -->
        <button id="submitBtn" style="display:none;">Submit</button>
      </div>
    </div>
    
    <div id="quizResult" style="margin-top:20px;"></div>
    <button onclick="showPage('menu-page')">Back to Menu</button>
  </div>
</section>

<section id="quiz-result-page" class="page hidden">
  <div class="container">
    <h2>Quiz Result</h2>
    <div id="quizResultContent"></div>
    <button id="reviewQuizBtn">Review Quiz</button>
    <button onclick="showPage('menu-page')">Back to Menu</button>
  </div>
</section>

<section id="quiz-review-page" class="page hidden">
  <div class="container">
    <h2>Review Quiz</h2>
    <div id="quizReviewContent"></div>
    <button onclick="showPage('quiz-result-page')">Back to Results</button>
    <button id="takeQuizAgainBtn">Take Quiz Again</button>

</div>
</section>





    <script>
    function showForm(type) {
        document.getElementById('choice-buttons').style.display = 'none';
        var form = document.getElementById('user-form');
        var title = document.getElementById('form-title');
        if(type === 'register') {
            form.action = '/register';
            title.textContent = 'Register';
        } else {
            form.action = '/login';
            title.textContent = 'Login';
        }
        form.style.display = 'block';
    }

    window.onload = function() {
        showPage('login-page');
    }

    // Fungsi untuk menampilkan satu halaman dan menyembunyikan yang lain
    function showPage(pageId) {
        // Sembunyikan semua section dengan class 'page'
        document.querySelectorAll('.page').forEach(p => {
            if (p.id === pageId) {
                p.classList.remove('hidden');
            } else {
                p.classList.add('hidden');
            }
        });
        // Sembunyikan/tampilkan login-page sesuai kebutuhan
        var loginPage = document.getElementById('login-page');
        if (loginPage) {
            if (pageId !== 'login-page') {
                loginPage.classList.add('hidden');
            } else {
                loginPage.classList.remove('hidden');
            }
            if (pageId === 'quiz-page') {
                startQuiz();
  }
        }
    }
    let currentUser = null;
    let bmiChart = null;
    let bmiData = [];

    function backToChoice() {
      document.getElementById('user-form').classList.add('hidden');
      document.getElementById('choice-buttons').style.display = 'flex';
      document.getElementById('user-form').reset();
    }

    document.getElementById('user-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const form = e.target;
      const data = new URLSearchParams(new FormData(form));

      fetch(form.action, { method: 'POST', body: data })
        .then(res => res.text())
        .then(result => {
          console.log('Server response:', result); // Debug log
          
                    if (form.action.endsWith('/login')) {
                        if (result.includes('Login berhasil')) {
                            currentUser = document.getElementById('username').value;
                            document.getElementById('current-user').textContent = currentUser;
                            showPage('menu-page');
                            loadBMIHistory();
                            // Sembunyikan form login
                            document.getElementById('user-form').classList.add('hidden');
                            document.getElementById('user-form').style.display = 'none';
                            document.getElementById('choice-buttons').style.display = 'flex';
                            document.getElementById('user-form').reset();
                        } else {
                            alert('Login failed: Wrong username or password');
                        }
                    } else {
                        // Registration response
                        if (result.includes('Registrasi berhasil')) {
                            alert('Registration successful! Please login now.');
                            // Switch to login form
                            document.getElementById('form-title').textContent = 'Login';
                            form.action = '/login';
                            document.getElementById('password').value = '';
                            // Sembunyikan form register, tampilkan tombol pilihan
                            document.getElementById('user-form').classList.add('hidden');
                            document.getElementById('user-form').style.display = 'none';
                            document.getElementById('choice-buttons').style.display = 'flex';
                        } else {
                            alert('Registration failed: Username already exists');
                        }
                    }
        })
        .catch(err => {
          console.error('Network error:', err);
          alert('Network error. Please try again.');
        });
    });

    document.getElementById('bmi-form').addEventListener('submit', function(e) {
        e.preventDefault();
        if (!currentUser) return alert("Login first!");
        
        const height = document.getElementById('height').value;
        const weight = document.getElementById('weight').value;
        
        if (!height || !weight || height < 100 || height > 250 || weight < 30 || weight > 200) {
            alert('Please enter valid height (100-250cm) and weight (30-200kg)');
            return;
        }
        
        const data = new URLSearchParams();
        data.append('username', currentUser);
        data.append('height', height);
        data.append('weight', weight);

        fetch('/bmi', { method: 'POST', body: data })
            .then(res => res.json())
            .then(result => {
            if (result.error) {
                alert('Error: ' + result.error);
                return;
            }
            
            // Show result
            document.getElementById('bmi-result').innerHTML = `
                <div class="bmi-result">
                <h3>Your BMI: ${result.bmi}</h3>
                <p class="bmi-status ${result.status.toLowerCase()}">${result.status}</p>
                <small>Calculated on ${new Date().toLocaleDateString()}</small>
                </div>
            `;

            // Add to chart data
            bmiData.push({
                date: new Date().toLocaleDateString(),
                value: parseFloat(result.bmi)
            });

            // Update chart
            updateBMIChart();
            loadBMIHistory();
            
            // Reset form
            e.target.reset();
            })
            .catch(err => {
            alert('Network error. Please try again.');
            console.error('BMI Error:', err);
            });
        });

        function updateBMIChart() {
        if (!bmiChart) {
            bmiChart = new Chart(document.getElementById('bmiChart'), {
            type: 'line',
            data: {
                labels: bmiData.map(d => d.date),
                datasets: [{
                label: 'BMI Progress',
                data: bmiData.map(d => d.value),
                borderColor: '#6366f1',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                borderWidth: 2,
                fill: true
                }]
            },
            options: {
                responsive: true,
                scales: {
                y: { beginAtZero: false, min: 15, max: 35 }
                }
            }
            });
        } else {
            bmiChart.data.labels = bmiData.map(d => d.date);
            bmiChart.data.datasets[0].data = bmiData.map(d => d.value);
            bmiChart.update();
        }
    }
    // === BMI HISTORY CRUD ===
function loadBMIHistory() {
    if (!currentUser) return;

    fetch(`/bmi-history?username=${currentUser}`)
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                document.getElementById("bmi-result").innerHTML = `<p>${data.error}</p>`;
                return;
            }

            // Simpan ke bmiData (untuk chart)
            bmiData = data.map(r => ({ date: r.date, value: parseFloat(r.value) }));
            updateBMIChart();

            // Render history list
            let html = "<h3>BMI History</h3><ul>";
            data.forEach(r => {
                html += `
                <li>
                    ${r.date} - <b>${r.value}</b> (${r.status})
                    <button onclick="editRecord(${r.id})">Edit</button>
                    <button onclick="deleteRecord(${r.id})">Delete</button>
                </li>`;
            });
            html += "</ul>";
            document.getElementById("bmi-result").innerHTML += html;
        })
        .catch(err => console.error("Error load history:", err));
}

function deleteRecord(id) {
    fetch('/bmi', { 
        method: 'DELETE',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ username: currentUser, id })
    }).then(res => res.json()).then(() => loadBMIHistory());
}

function editRecord(id) {
    let height = prompt("Masukkan tinggi baru (cm):");
    let weight = prompt("Masukkan berat baru (kg):");
    if (!height || !weight) return;

    fetch('/bmi', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ username: currentUser, id, height, weight })
    }).then(res => res.json()).then(() => loadBMIHistory());
}


let selectedMood = null;

function selectMood(mood) {
  selectedMood = mood;
  document.getElementById("mood-step-1").classList.add("hidden");
  document.getElementById("mood-step-2").classList.remove("hidden");
}

function cancelMood() {
  selectedMood = null;
  document.getElementById("mood-step-2").classList.add("hidden");
  document.getElementById("mood-step-1").classList.remove("hidden");
}

function saveMood() {
  const note = document.getElementById("mood-note").value;
  if (!selectedMood || !note) return alert("Please select mood and write notes");

  fetch("/mood", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username: currentUser, mood: selectedMood, note })
  })
  .then(res => res.json())
  .then(() => {
    document.getElementById("mood-step-2").classList.add("hidden");
    document.getElementById("mood-step-3").classList.remove("hidden");
    loadMoodCalendar();
  });
}

function loadMoodCalendar() {
  fetch(`/mood-history?username=${currentUser}`)
    .then(res => res.json())
    .then(data => {
      renderCalendar(data);
      renderMoodStats(data);
    });
}

function renderCalendar(moods) {
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth();
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();

  let calendarHTML = "";
  for (let i = 0; i < firstDay; i++) {
    calendarHTML += `<div class="calendar-day empty"></div>`;
  }
  for (let d = 1; d <= daysInMonth; d++) {
    let dateStr = `${year}-${String(month+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    let mood = moods.find(m => m.date === dateStr);
    calendarHTML += `<div class="calendar-day ${mood ? mood.mood : ''}">${d}</div>`;
  }
  document.getElementById("calendar").innerHTML = calendarHTML;
}


function renderMoodStats(moods) {
  let counts = { happy:0, sad:0, angry:0, fear:0, disgusted:0 };
  moods.forEach(m => counts[m.mood]++);
  
  let statsHTML = "<h3>Mood Count</h3><ul>";
  for (let mood in counts) {
    statsHTML += `<li>${mood}: ${counts[mood]}</li>`;
  }
  statsHTML += "</ul>";

  let todayStr = new Date().toISOString().split("T")[0];
  let todayMood = moods.find(m => m.date === todayStr);
  let todayHTML = todayMood 
    ? `<h3>Today's Mood</h3><p>${todayMood.mood} - ${todayMood.note}</p>` 
    : `<p>No mood recorded today</p>`;

  document.getElementById("mood-count").innerHTML = statsHTML;
  document.getElementById("today-mood").innerHTML = todayHTML;
}

// === quiz data (HARUS dideklarasikan sebelum fungsi yang memakainya) ===
// === quiz data (updated English + more questions) ===
const quizQuestions = [
  {
    question: "Which part of your body is wider?",
    options: [
      { text: "Shoulders wider than hips", value: "inverted" },
      { text: "Hips wider than shoulders", value: "pear" },
      { text: "Shoulders and hips balanced, waist defined", value: "hourglass" },
      { text: "Shoulders and hips balanced, waist less defined", value: "rectangle" }
    ],
    key: "shape1"
  },
  {
    question: "Which area is most prominent?",
    options: [
      { text: "Very slim waist", value: "hourglass" },
      { text: "Prominent hips", value: "pear" },
      { text: "Prominent shoulders", value: "inverted" },
      { text: "No area stands out", value: "rectangle" }
    ],
    key: "shape2"
  },
  {
    question: "When wearing pants or skirts, where is the fit usually an issue?",
    options: [
      { text: "Too big at waist, fits hips well", value: "pear" },
      { text: "Fits shoulders, loose at hips", value: "inverted" },
      { text: "Always fits evenly", value: "hourglass" },
      { text: "All areas usually too loose or tight", value: "rectangle" }
    ],
    key: "shape3"
  },
  {
    question: "How would you describe your torso length?",
    options: [
      { text: "Short torso", value: "pear" },
      { text: "Long torso", value: "inverted" },
      { text: "Proportional torso", value: "hourglass" },
      { text: "Straight torso without curves", value: "rectangle" }
    ],
    key: "shape4"
  },
  {
    question: "How would you describe your arms and legs?",
    options: [
      { text: "Slim arms and legs", value: "hourglass" },
      { text: "Thicker thighs or upper arms", value: "pear" },
      { text: "Broad shoulders and arms", value: "inverted" },
      { text: "Evenly proportioned, minimal curves", value: "rectangle" }
    ],
    key: "shape5"
  },
  {
    question: "Which statement best describes your waistline?",
    options: [
      { text: "Clearly defined waist", value: "hourglass" },
      { text: "Slightly defined waist", value: "rectangle" },
      { text: "Waist less defined than hips", value: "pear" },
      { text: "Waist less defined than shoulders", value: "inverted" }
    ],
    key: "shape6"
  }
];

let currentQuestion = 0;
let answers = {};

function startQuiz() {
  currentQuestion = 0;
  answers = {};
  document.getElementById("quiz-page").style.display = "block";
  document.getElementById("menu-page").style.display = "none";
  showQuestion();
}


function showQuestion() {
  const q = quizQuestions[currentQuestion];

  const quizBox = document.getElementById("quizOptions");
  quizBox.innerHTML = ""; // reset

  const card = document.createElement("div");
  card.className = "quiz-card";

  const questionEl = document.createElement("p");
  questionEl.id = "quizQuestion";
  questionEl.innerText = q.question;
  card.appendChild(questionEl);

  q.options.forEach(opt => {
    const btn = document.createElement("button");
    btn.innerText = opt.text;

    if (answers[q.key] === opt.value) btn.classList.add("selected");

    btn.onclick = () => {
      answers[q.key] = opt.value;
      Array.from(card.querySelectorAll("button")).forEach(b => b.classList.remove("selected"));
      btn.classList.add("selected");

      if (currentQuestion < quizQuestions.length - 1) {
        currentQuestion++;
        showQuestion();
      } else {
        document.getElementById("submitBtn").style.display = "inline-block";
        document.getElementById("nextBtn").style.display = "none";
      }
    };
    card.appendChild(btn);
  });

  quizBox.appendChild(card);

  // navigasi
  document.getElementById("backBtn").style.display = currentQuestion > 0 ? "inline-block" : "none";
  document.getElementById("nextBtn").style.display = (currentQuestion < quizQuestions.length - 1) ? "inline-block" : "none";
  document.getElementById("submitBtn").style.display = "none";

  // di awal, sembunyiin submit
  document.getElementById("submitBtn").style.display = "none";
}


document.getElementById("backBtn").addEventListener("click", () => {
  if (currentQuestion > 0) {
    currentQuestion--;
    showQuestion();
  }
});

document.getElementById("nextBtn").addEventListener("click", () => {
  if (currentQuestion < quizQuestions.length - 1) {
    currentQuestion++;
    showQuestion();
  }
});

document.getElementById("submitBtn").addEventListener("click", finishQuiz);

function finishQuiz() {
  let counts = { pear: 0, inverted: 0, hourglass: 0, rectangle: 0 };
  Object.values(answers).forEach(val => counts[val]++);

  let result = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b);

  let recommendation = "";
  switch (result) {
    case "pear":
      recommendation = `
      Your body shape is Pear üçê. <br>
      <ul>
        <li>Highlight your upper body with bright or detailed tops.</li>
        <li>Choose A-line skirts or wide-leg pants to balance hips.</li>
        <li>Avoid bottoms that add extra volume to your hips.</li>
      </ul>`;
      break;
    case "inverted":
      recommendation = `
      Your body shape is Inverted Triangle üî∫. <br>
      <ul>
        <li>Wear simple tops to minimize shoulder width.</li>
        <li>Flared or wide-leg pants can add volume to lower body.</li>
        <li>Avoid shoulder pads or heavily decorated tops.</li>
      </ul>`;
      break;
    case "hourglass":
      recommendation = `
      Your body shape is Hourglass ‚è≥. <br>
      <ul>
        <li>Highlight your waist with fitted dresses or belts.</li>
        <li>Bodycon dresses or outfits that show curves work well.</li>
        <li>Avoid shapeless, boxy clothes that hide your waist.</li>
      </ul>`;
      break;
    case "rectangle":
      recommendation = `
      Your body shape is Rectangle ‚ñ≠. <br>
      <ul>
        <li>Create curves with peplum tops or belts.</li>
        <li>Layered outfits or ruffles add dimension.</li>
        <li>Avoid straight-cut outfits that hide the waist completely.</li>
      </ul>`;
      break;
  }

  // Kirim hasil quiz ke server
fetch('/quiz', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
        username: currentUser,
        answers,
        result,
        recommendation
    })
}).then(res => res.json())
  .then(data => console.log('Quiz saved:', data))
  .catch(err => console.error('Quiz save error:', err));


  // Pindah ke page hasil
  showPage('quiz-result-page');

  // Tampilkan hasil
  document.getElementById("quizResultContent").innerHTML = `
    <p><strong>Body Shape:</strong> ${result}</p>
    <p><strong>Style Recommendations:</strong> ${recommendation}</p>
  `;

  // simpan hasil & jawaban terakhir untuk review
  window.lastQuizAnswers = { answers, result, recommendation };
}


document.getElementById("reviewQuizBtn").addEventListener("click", () => {
  showPage('quiz-review-page');
  
  const reviewDiv = document.getElementById("quizReviewContent");
  reviewDiv.innerHTML = ""; // reset

  const { answers } = window.lastQuizAnswers;
  
  quizQuestions.forEach((q, idx) => {
    const userAnswer = answers[q.key];
    const qDiv = document.createElement("div");
    qDiv.innerHTML = `<p><strong>Q${idx+1}:</strong> ${q.question}</p>`;
    
    q.options.forEach(opt => {
      const checked = (opt.value === userAnswer) ? "‚úÖ" : "";
      const p = document.createElement("p");
      p.textContent = `${opt.text} ${checked}`;
      qDiv.appendChild(p);
    });

    reviewDiv.appendChild(qDiv);
  });
});

// --- Take Quiz Again Button ---
document.getElementById("takeQuizAgainBtn").addEventListener("click", () => {
    if (!currentUser) return alert("Please login first!");

    // Reset state quiz
    currentQuestion = 0;
    answers = {};

    // Hapus hasil review
    document.getElementById("quizReviewContent").innerHTML = "";
    
    // Tampilkan quiz page tanpa pengecekan lastQuizAnswers
    startQuiz(true); // kasih parameter skipLastQuiz
});

        









    </script>
</body>
</html>
