<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bloomii</title>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <section id="login-page">
        <h1>WELCOME TO BLOOMII =)</h1>
        <h2>Be the best version of yourself with us. </h2>
        <h2>You can explore the world of bloomii by log in or register, the choice is yours!</h2>
        <div id="choice-buttons">
            <button onclick="showForm('register')" type="button">Register</button>
            <button onclick="showForm('login')" type="button">Login</button>
        </div>

        <form id="user-form" action="" method="POST" style="display:none;">
            <h2 id="form-title"></h2>
            <label for="Uname">Username</label>
            <input type="text" id="username" name="username" required
            pattern="^[a-zA-Z0-9_]{3,15}$"
            title="Username harus 3-15 karakter dan hanya boleh huruf, angka, dan underscore">
            <br>
            <label for="">Password</label>
            <input type="password" name="password" placeholder="Password"
        pattern="^(?=.*[A-Za-z])(?=.*\d)(?=.*[@$!%*?&]).+$"
        title="Harus mengandung huruf, angka, dan simbol.">
            <br><br>
            <button type="submit">Submit</button>
            <button type="button" onclick="backToChoice()">Back</button>
        </form>
    </section>

    <section id="menu-page" class="page hidden">
        <div class="container">
        <h2>Welcome, <span id="current-user"></span>!</h2>
        <div class="menu-buttons">
            <button onclick="showPage('bmi-page')">BMI Tracker</button>
            <button onclick="showPage('mood-page')">Mood Calendar</button>
            <button onclick="logout()">Logout</button>
        </div>
        </div>
    </section>

    <section id="bmi-page" class="page hidden">
        <div class="container">
        <h2>BMI Tracker</h2>
        <form id="bmi-form">
            <div class="form-group">
            <label for="height">Height (cm)</label>
            <input type="number" id="height" name="height" required min="100" max="250">
            </div>
            <div class="form-group">
            <label for="weight">Weight (kg)</label>
            <input type="number" id="weight" name="weight" required min="30" max="200" step="0.1">
            </div>
            <button type="submit">Calculate BMI</button>
        </form>
        <div id="bmi-result"></div>
        <canvas id="bmiChart" style="margin: 20px 0;"></canvas>
        <button onclick="showPage('menu-page')">Back</button>
        </div>
    </section>

    <script>
    function showForm(type) {
        document.getElementById('choice-buttons').style.display = 'none';
        var form = document.getElementById('user-form');
        var title = document.getElementById('form-title');
        if(type === 'register') {
            form.action = '/register';
            title.textContent = 'Register';
        } else {
            form.action = '/login';
            title.textContent = 'Login';
        }
        form.style.display = 'block';
    }

    window.onload = function() {
        showPage('login-page');
    }

    // Fungsi untuk menampilkan satu halaman dan menyembunyikan yang lain
    function showPage(pageId) {
        // Sembunyikan semua section dengan class 'page'
        document.querySelectorAll('.page').forEach(p => {
            if (p.id === pageId) {
                p.classList.remove('hidden');
            } else {
                p.classList.add('hidden');
            }
        });
        // Sembunyikan/tampilkan login-page sesuai kebutuhan
        var loginPage = document.getElementById('login-page');
        if (loginPage) {
            if (pageId !== 'login-page') {
                loginPage.classList.add('hidden');
            } else {
                loginPage.classList.remove('hidden');
            }
        }
    }
    let currentUser = null;
    let bmiChart = null;
    let bmiData = [];

    function backToChoice() {
      document.getElementById('user-form').classList.add('hidden');
      document.getElementById('choice-buttons').style.display = 'flex';
      document.getElementById('user-form').reset();
    }

    document.getElementById('user-form').addEventListener('submit', function(e) {
      e.preventDefault();
      const form = e.target;
      const data = new URLSearchParams(new FormData(form));

      fetch(form.action, { method: 'POST', body: data })
        .then(res => res.text())
        .then(result => {
          console.log('Server response:', result); // Debug log
          
                    if (form.action.endsWith('/login')) {
                        if (result.includes('Login berhasil')) {
                            currentUser = document.getElementById('username').value;
                            document.getElementById('current-user').textContent = currentUser;
                            showPage('menu-page');
                            loadBMIHistory();
                            // Sembunyikan form login
                            document.getElementById('user-form').classList.add('hidden');
                            document.getElementById('user-form').style.display = 'none';
                            document.getElementById('choice-buttons').style.display = 'flex';
                            document.getElementById('user-form').reset();
                        } else {
                            alert('Login failed: Wrong username or password');
                        }
                    } else {
                        // Registration response
                        if (result.includes('Registrasi berhasil')) {
                            alert('Registration successful! Please login now.');
                            // Switch to login form
                            document.getElementById('form-title').textContent = 'Login';
                            form.action = '/login';
                            document.getElementById('password').value = '';
                            // Sembunyikan form register, tampilkan tombol pilihan
                            document.getElementById('user-form').classList.add('hidden');
                            document.getElementById('user-form').style.display = 'none';
                            document.getElementById('choice-buttons').style.display = 'flex';
                        } else {
                            alert('Registration failed: Username already exists');
                        }
                    }
        })
        .catch(err => {
          console.error('Network error:', err);
          alert('Network error. Please try again.');
        });
    });

    document.getElementById('bmi-form').addEventListener('submit', function(e) {
        e.preventDefault();
        if (!currentUser) return alert("Login first!");
        
        const height = document.getElementById('height').value;
        const weight = document.getElementById('weight').value;
        
        if (!height || !weight || height < 100 || height > 250 || weight < 30 || weight > 200) {
            alert('Please enter valid height (100-250cm) and weight (30-200kg)');
            return;
        }
        
        const data = new URLSearchParams();
        data.append('username', currentUser);
        data.append('height', height);
        data.append('weight', weight);

        fetch('/bmi', { method: 'POST', body: data })
            .then(res => res.json())
            .then(result => {
            if (result.error) {
                alert('Error: ' + result.error);
                return;
            }
            
            // Show result
            document.getElementById('bmi-result').innerHTML = `
                <div class="bmi-result">
                <h3>Your BMI: ${result.bmi}</h3>
                <p class="bmi-status ${result.status.toLowerCase()}">${result.status}</p>
                <small>Calculated on ${new Date().toLocaleDateString()}</small>
                </div>
            `;

            // Add to chart data
            bmiData.push({
                date: new Date().toLocaleDateString(),
                value: parseFloat(result.bmi)
            });

            // Update chart
            updateBMIChart();
            loadBMIHistory();
            
            // Reset form
            e.target.reset();
            })
            .catch(err => {
            alert('Network error. Please try again.');
            console.error('BMI Error:', err);
            });
        });

        function updateBMIChart() {
        if (!bmiChart) {
            bmiChart = new Chart(document.getElementById('bmiChart'), {
            type: 'line',
            data: {
                labels: bmiData.map(d => d.date),
                datasets: [{
                label: 'BMI Progress',
                data: bmiData.map(d => d.value),
                borderColor: '#6366f1',
                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                borderWidth: 2,
                fill: true
                }]
            },
            options: {
                responsive: true,
                scales: {
                y: { beginAtZero: false, min: 15, max: 35 }
                }
            }
            });
        } else {
            bmiChart.data.labels = bmiData.map(d => d.date);
            bmiChart.data.datasets[0].data = bmiData.map(d => d.value);
            bmiChart.update();
        }
    }
    // === BMI HISTORY CRUD ===
function loadBMIHistory() {
    if (!currentUser) return;

    fetch(`/bmi-history?username=${currentUser}`)
        .then(res => res.json())
        .then(data => {
            if (data.error) {
                document.getElementById("bmi-result").innerHTML = `<p>${data.error}</p>`;
                return;
            }

            // Simpan ke bmiData (untuk chart)
            bmiData = data.map(r => ({ date: r.date, value: parseFloat(r.value) }));
            updateBMIChart();

            // Render history list
            let html = "<h3>BMI History</h3><ul>";
            data.forEach(r => {
                html += `
                <li>
                    ${r.date} - <b>${r.value}</b> (${r.status})
                    <button onclick="editRecord(${r.id})">Edit</button>
                    <button onclick="deleteRecord(${r.id})">Delete</button>
                </li>`;
            });
            html += "</ul>";
            document.getElementById("bmi-result").innerHTML += html;
        })
        .catch(err => console.error("Error load history:", err));
}

function deleteRecord(id) {
    fetch('/bmi', { 
        method: 'DELETE',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ username: currentUser, id })
    }).then(res => res.json()).then(() => loadBMIHistory());
}

function editRecord(id) {
    let height = prompt("Masukkan tinggi baru (cm):");
    let weight = prompt("Masukkan berat baru (kg):");
    if (!height || !weight) return;

    fetch('/bmi', {
        method: 'PUT',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({ username: currentUser, id, height, weight })
    }).then(res => res.json()).then(() => loadBMIHistory());
}


let selectedMood = null;

function selectMood(mood) {
  selectedMood = mood;
  document.getElementById("mood-step-1").classList.add("hidden");
  document.getElementById("mood-step-2").classList.remove("hidden");
}

function cancelMood() {
  selectedMood = null;
  document.getElementById("mood-step-2").classList.add("hidden");
  document.getElementById("mood-step-1").classList.remove("hidden");
}

function saveMood() {
  const note = document.getElementById("mood-note").value;
  if (!selectedMood || !note) return alert("Please select mood and write notes");

  fetch("/mood", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ username: currentUser, mood: selectedMood, note })
  })
  .then(res => res.json())
  .then(() => {
    document.getElementById("mood-step-2").classList.add("hidden");
    document.getElementById("mood-step-3").classList.remove("hidden");
    loadMoodCalendar();
  });
}

function loadMoodCalendar() {
  fetch(`/mood-history?username=${currentUser}`)
    .then(res => res.json())
    .then(data => {
      renderCalendar(data);
      renderMoodStats(data);
    });
}

function renderCalendar(moods) {
  const today = new Date();
  const year = today.getFullYear();
  const month = today.getMonth();
  const firstDay = new Date(year, month, 1).getDay();
  const daysInMonth = new Date(year, month + 1, 0).getDate();

  let calendarHTML = "";
  for (let i = 0; i < firstDay; i++) {
    calendarHTML += `<div class="calendar-day empty"></div>`;
  }
  for (let d = 1; d <= daysInMonth; d++) {
    let dateStr = `${year}-${String(month+1).padStart(2,"0")}-${String(d).padStart(2,"0")}`;
    let mood = moods.find(m => m.date === dateStr);
    calendarHTML += `<div class="calendar-day ${mood ? mood.mood : ''}">${d}</div>`;
  }
  document.getElementById("calendar").innerHTML = calendarHTML;
}

function renderMoodStats(moods) {
  let counts = { happy:0, sad:0, angry:0, fear:0, disgusted:0 };
  moods.forEach(m => counts[m.mood]++);
  
  let statsHTML = "<h3>Mood Count</h3><ul>";
  for (let mood in counts) {
    statsHTML += `<li>${mood}: ${counts[mood]}</li>`;
  }
  statsHTML += "</ul>";

  let todayStr = new Date().toISOString().split("T")[0];
  let todayMood = moods.find(m => m.date === todayStr);
  let todayHTML = todayMood 
    ? `<h3>Today's Mood</h3><p>${todayMood.mood} - ${todayMood.note}</p>` 
    : `<p>No mood recorded today</p>`;

  document.getElementById("mood-count").innerHTML = statsHTML;
  document.getElementById("today-mood").innerHTML = todayHTML;
}


<section id="mood-page" class="page hidden">
  <div class="container" id="mood-step-1">
    <h2>How are you today?</h2>
    <div class="emoji-options">
      <button onclick="selectMood('happy')">😊</button>
      <button onclick="selectMood('sad')">😢</button>
      <button onclick="selectMood('angry')">😡</button>
      <button onclick="selectMood('fear')">😨</button>
      <button onclick="selectMood('disgusted')">🤢</button>
    </div>
    <button onclick="showPage('menu-page')">Back</button>
  </div>

  <div class="container hidden" id="mood-step-2">
    <h2>Write your journal</h2>
    <textarea id="mood-note" placeholder="How was your day?"></textarea>
    <br>
    <button onclick="saveMood()">Save</button>
    <button onclick="cancelMood()">Cancel</button>
  </div>

  <div class="container hidden" id="mood-step-3">
    <h2>Your Mood Calendar</h2>
    <div id="calendar"></div>
    <div id="mood-count"></div>
    <div id="today-mood"></div>
    <button onclick="showPage('menu-page')">Back</button>
  </div>
</section>



    </script>
</body>
</html>
